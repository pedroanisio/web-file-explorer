{% extends "_base.html" %}

{% block title %}File Explorer{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumb flex flex-wrap items-center justify-between">
    <div>
        <a href="{{ url_for('explore', path='') }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">Home</a>
        {% if current_path %}
            {% set path_segments = current_path.split('/') %}
            {% set accumulated_path = '' %}
            {% for segment in path_segments %}
                {% if segment %}
                    {% set accumulated_path = accumulated_path + segment + '/' %}
                    / <a href="{{ url_for('explore', path=accumulated_path) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">{{ segment }}</a>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
    <button id="add-favorite-btn" data-current-path="{{ current_path }}" class="btn-blue text-sm">Add Favorite</button>
</div>
{% endblock %}

{% block toolbar %}
<!-- Plugin Toolbar -->
{% if plugins %}
<div class="toolbar flex flex-wrap gap-2 mb-4">
    {% for plugin in plugins %}
    <button class="toolbar-item btn-gray" data-plugin-id="{{ plugin.id }}" data-current-path="{{ current_path }}" title="{{ plugin.description }}" aria-label="{{ plugin.name }} plugin button">
        <span class="toolbar-item-icon">{{ plugin.icon }}</span>
        <span>{{ plugin.name }}</span>
    </button>
    {% endfor %}
</div>
{% endif %}

<div id="favorites-bar" class="favorites-bar mb-4"></div>

<div class="controls flex flex-wrap gap-4 justify-between items-center mb-4">
    <div class="sort-options flex items-center gap-2">
        <span>Sort by:</span>
        <a href="{{ url_for('explore', path=current_path, sort='name', desc='false' if sort_by == 'name' and not sort_desc else 'true', search=search) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">
            Name
            {% if sort_by == 'name' %}
                <span class="sort-arrow {{ 'down' if sort_desc else 'up' }}"></span>
            {% endif %}
        </a>
        <a href="{{ url_for('explore', path=current_path, sort='modified', desc='false' if sort_by == 'modified' and not sort_desc else 'true', search=search) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">
            Modified
            {% if sort_by == 'modified' %}
                <span class="sort-arrow {{ 'down' if sort_desc else 'up' }}"></span>
            {% endif %}
        </a>
        <a href="{{ url_for('explore', path=current_path, sort='size', desc='false' if sort_by == 'size' and not sort_desc else 'true', search=search) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">
            Size
            {% if sort_by == 'size' %}
                <span class="sort-arrow {{ 'down' if sort_desc else 'up' }}"></span>
            {% endif %}
        </a>
    </div>
    
    <form class="search-form" method="get" action="{{ url_for('explore', path=current_path) }}">
        <input type="text" name="search" placeholder="Search in current folder..." value="{{ search }}" class="px-3 py-2 rounded border {{ 'bg-gray-800 border-gray-700 text-gray-200 placeholder-gray-500' if theme == 'dark' else 'bg-white border-gray-300 text-gray-800 placeholder-gray-400' }}">
        <input type="hidden" name="sort" value="{{ sort_by }}">
        <input type="hidden" name="desc" value="{{ 'true' if sort_desc else 'false' }}">
    </form>

    <div class="actions flex items-center gap-2">
        <div class="select-controls flex items-center gap-2">
            <button id="select-toggle" type="button" class="btn-gray">Select</button>
            <div id="selection-actions" class="hidden space-x-2">
                <button id="select-all" type="button" class="btn-gray">Select All</button>
                <button id="deselect-all" type="button" class="btn-gray">Deselect All</button>
                <button id="download-selected" type="button" class="btn-blue">Download Selected (<span id="selected-count">0</span>)</button>
            </div>
        </div>
        <button id="toggle-preview-pane" class="btn-blue">Toggle Preview</button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="content-wrapper flex">
    <div class="content-container flex-1">
        <div class="card">
            <table class="table w-full">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <th class="select-column hidden p-3"></th>
                        <th class="p-3 text-left" scope="col">Name</th>
                        <th class="p-3 text-left" scope="col">Modified</th>
                        <th class="p-3 text-left" scope="col">Size</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% if parent_path is not none %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="select-column hidden p-3"></td>
                        <td class="p-3">
                            <span class="folder-icon text-blue-500 dark:text-blue-400 mr-2">üìÅ</span>
                            <a href="{{ url_for('explore', path=parent_path) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">..</a>
                        </td>
                        <td class="p-3"></td>
                        <td class="p-3"></td>
                    </tr>
                    {% endif %}
                    
                    {% for dir in dirs %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="select-column hidden p-3"><input type="checkbox" class="select-checkbox" data-path="{{ dir.path }}"></td>
                        <td class="p-3">
                            <span class="folder-icon text-blue-500 dark:text-blue-400 mr-2">üìÅ</span>
                            <a href="{{ url_for('explore', path=dir.path) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">{{ dir.name }}/</a>
                        </td>
                        <td class="p-3 text-gray-500 dark:text-gray-400">{{ dir.modified }}</td>
                        <td class="p-3"></td>
                    </tr>
                    {% endfor %}
                    
                    {% for file in files %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors file-row" data-file-path="{{ file.path }}">
                        <td class="select-column hidden p-3"><input type="checkbox" class="select-checkbox" data-path="{{ file.path }}"></td>
                        <td class="p-3">
                            <span class="file-icon text-gray-500 dark:text-gray-400 mr-2">üìÑ</span>
                            <a href="{{ url_for('explore', path=file.path) }}" class="{{ 'text-blue-400 hover:text-blue-300' if theme == 'dark' else 'text-blue-600 hover:text-blue-800' }}">{{ file.name }}</a>
                            <button class="ml-2 text-sm badge-blue preview-link" data-preview-url="{{ get_preview_url(file.path) }}">Preview</button>
                        </td>
                        <td class="p-3 text-gray-500 dark:text-gray-400">{{ file.modified }}</td>
                        <td class="p-3 text-gray-500 dark:text-gray-400">
                            {% if file.size < 1024 %}
                                {{ file.size }} bytes
                            {% elif file.size < 1024 * 1024 %}
                                {{ (file.size / 1024) | round(1) }} KB
                            {% elif file.size < 1024 * 1024 * 1024 %}
                                {{ (file.size / 1024 / 1024) | round(1) }} MB
                            {% else %}
                                {{ (file.size / 1024 / 1024 / 1024) | round(1) }} GB
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}

                    {% if not dirs and not files %}
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">
                            {% if search %}
                                No items found matching "{{ search }}"
                            {% else %}
                                This folder is empty
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Preview Pane -->
    <div id="preview-pane" class="preview-pane hidden w-1/2 ml-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Preview</h3>
                <button id="close-preview" class="text-lg font-bold text-red-500 hover:text-red-700">&times;</button>
            </div>
            <div class="card-body">
                <div id="preview-loading" class="loading-indicator hidden">Loading...</div>
                <iframe id="preview-frame" class="w-full h-full hidden" sandbox="allow-same-origin"></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/preview.js') }}" defer></script>
{% endblock %}